version: '3.8'
services:
  synapse-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: synapse/core:3.1.0-test
    container_name: synapse-test
    environment:
    - SYNAPSE_ENV=test
    - DATABASE_URL=postgresql://test:test@postgres:5432/synapse_test
    - VECTOR_DB_URL=http://chromadb:8000
    - PROTOCOL_VERSION=1.0
    - SPEC_VERSION=3.1
    depends_on:
      postgres:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    command: pytest tests/ -v -m "integration"
    networks:
    - synapse-network
  postgres:
    image: postgres:15
    environment:
    - POSTGRES_PASSWORD=test
    - POSTGRES_DB=synapse_test
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
    - synapse-network
  chromadb:
    image: chromadb/chroma:latest
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/api/v1/heartbeat
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
    - synapse-network
networks:
  synapse-network:
    driver: bridge
