version: '3.8'
services:
  synapse-core:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: synapse/core:3.1.0
    container_name: synapse-core
    ports:
    - 8000:8000
    - 9090:9090
    volumes:
    - synapse_config:/app/config
    - synapse_data:/app/data
    - synapse_skills:/app/skills
    environment:
    - MODE=production
    - DATABASE_URL=postgresql://synapse:${DB_PASSWORD}@db:5432/synapse
    - VECTOR_DB_URL=http://qdrant:6333
    - REDIS_URL=redis://redis:6379
    - PROTOCOL_VERSION=1.0
    - SPEC_VERSION=3.1
    - LOG_LEVEL=INFO
    depends_on:
      db:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    restart: unless-stopped
    networks:
    - synapse-network
  db:
    image: postgres:15
    container_name: synapse-db
    volumes:
    - postgres_data:/var/lib/postgresql/data
    environment:
    - POSTGRES_DB=synapse
    - POSTGRES_USER=synapse
    - POSTGRES_PASSWORD=${DB_PASSWORD}
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U synapse -d synapse
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - synapse-network
    restart: unless-stopped
  qdrant:
    image: qdrant/qdrant:latest
    container_name: synapse-qdrant
    volumes:
    - qdrant_data:/qdrant/storage
    ports:
    - 6333:6333
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:6333/readyz
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - synapse-network
    restart: unless-stopped
  redis:
    image: redis:7
    container_name: synapse-redis
    volumes:
    - redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - synapse-network
    restart: unless-stopped
  prometheus:
    image: prom/prometheus:latest
    container_name: synapse-prometheus
    volumes:
    - ./prometheus.yml:/etc/prometheus/prometheus.yml
    - prometheus_data:/prometheus
    ports:
    - 9090:9090
    depends_on:
    - synapse-core
    networks:
    - synapse-network
    restart: unless-stopped
  grafana:
    image: grafana/grafana:latest
    container_name: synapse-grafana
    volumes:
    - grafana_data:/var/lib/grafana
    - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
    ports:
    - 3000:3000
    environment:
    - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    depends_on:
    - prometheus
    networks:
    - synapse-network
    restart: unless-stopped
volumes:
  synapse_config: {}
  synapse_data: {}
  synapse_skills: {}
  postgres_data: {}
  qdrant_data: {}
  redis_data: {}
  prometheus_data: {}
  grafana_data: {}
networks:
  synapse-network:
    driver: bridge
